<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·å°åŠ©æ‰‹ - é¦¨å©·çš„å®¶ä¹¦</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="top-bar">
            <button class="nav-btn" onclick="goBack()" title="è¿”å›">â†</button>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                    <span id="themeIcon">ğŸŒ™</span>
                </button>
                <div class="voice-toggle" id="voiceToggle" onclick="toggleVoice()">
                    <span id="voiceIcon">ğŸ”‡</span>
                    <span id="voiceText">è¯­éŸ³å…³</span>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤æŒ‡ç¤º -->
        <div class="text-center mb-4" id="stepText" style="color: var(--text-sub); margin-bottom: 24px;">
            ç¬¬ 1 æ­¥ / å…± 3 æ­¥
        </div>

        <!-- ç¬¬1æ­¥ï¼šé€‰æ‹©è°ä¸èˆ’æœ -->
        <div class="page active" id="page1">
            <div class="card-glass text-center">
                <div style="font-size: 50px; margin-bottom: 20px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                <h2 class="mb-4">è°ä¸èˆ’æœå‘€ï¼Ÿ</h2>
                <p style="color:var(--text-sub); margin-bottom: 30px;">é¦¨å©·æ¥å¸®æ‚¨åˆ†æä¸€ä¸‹</p>

                <button class="btn btn-primary" onclick="selectPerson('çˆ·çˆ·')">
                    <span style="font-size: 24px; margin-right: 10px;">ğŸ‘´</span> çˆ·çˆ·ä¸èˆ’æœ
                </button>
                <button class="btn btn-primary" onclick="selectPerson('å©†å©†')">
                    <span style="font-size: 24px; margin-right: 10px;">ğŸ‘µ</span> å©†å©†ä¸èˆ’æœ
                </button>
            </div>
        </div>

        <!-- ç¬¬2æ­¥ï¼šé€‰æ‹©èº«ä½“éƒ¨ä½ -->
        <div class="page" id="page2">
            <div class="card-glass">
                <h2 class="text-center mb-4">ğŸ§ å“ªé‡Œä¸èˆ’æœï¼Ÿ</h2>

                <div class="body-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="body-card" onclick="selectBodyPart('head')">
                        <span class="body-icon">ğŸ§ </span>
                        <span class="body-label">å¤´éƒ¨</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('eyes')">
                        <span class="body-icon">ğŸ‘ï¸</span>
                        <span class="body-label">çœ¼ç›</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('nose')">
                        <span class="body-icon">ğŸ‘ƒ</span>
                        <span class="body-label">é¼»å­</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('ears')">
                        <span class="body-icon">ğŸ‘‚</span>
                        <span class="body-label">è€³æœµ</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('neck')">
                        <span class="body-icon">ğŸ§£</span>
                        <span class="body-label">é¢ˆæ¤/è‚©è†€</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('chest')">
                        <span class="body-icon">ğŸ’—</span>
                        <span class="body-label">èƒ¸å£/å¿ƒè„</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('stomach')">
                        <span class="body-icon">ğŸ«ƒ</span>
                        <span class="body-label">è‚šå­/è‚ èƒƒ</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('limbs')">
                        <span class="body-icon">ğŸ¦µ</span>
                        <span class="body-label">èƒ³è†Š/è…¿è„š</span>
                    </div>
                    <div class="body-card" onclick="selectBodyPart('whole')">
                        <span class="body-icon">ğŸ§˜</span>
                        <span class="body-label">å…¨èº«ä¸èˆ’æœ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¬¬3æ­¥ï¼šé€‰æ‹©å…·ä½“ç—‡çŠ¶ -->
        <div class="page" id="page3">
            <div class="card-glass">
                <div class="text-center mb-4">
                    <span id="symptomIcon" style="font-size: 40px;"></span>
                    <h2 id="symptomPageTitle" style="margin-top: 10px;">æœ‰ä»€ä¹ˆç—‡çŠ¶ï¼Ÿ</h2>
                    <p style="color:var(--text-sub); font-size: 14px;">(å¯ä»¥å¤šé€‰å‡ ä¸ª)</p>
                </div>

                <div id="symptomsGrid" style="text-align: center; margin-bottom: 30px;">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div style="background: rgba(0,0,0,0.03); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-sub); margin-bottom: 8px;">å·²é€‰æ‹©ï¼š</div>
                    <div id="selectedTags" style="display:flex; flex-wrap:wrap; gap:8px; min-height: 30px;">
                        <span style="color:#a0aec0;">ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©ç—‡çŠ¶</span>
                    </div>
                </div>

                <button class="btn btn-success" id="submitBtn" onclick="submitSymptoms()" disabled>
                    ğŸ¤– å¼€å§‹åˆ†æ
                </button>
            </div>
        </div>

        <!-- ç¬¬4æ­¥ï¼šæ˜¾ç¤ºç»“æœ -->
        <div class="page" id="page4">
            <div class="card-glass">
                <!-- åŠ è½½ä¸­ -->
                <div id="loadingState" class="text-center" style="padding: 40px 0;">
                    <div style="font-size: 40px; animation: bounce 1s infinite;">ğŸ¤”</div>
                    <p style="margin-top: 20px; color: var(--text-sub);">é¦¨å©·æ­£åœ¨æ€è€ƒä¸­...</p>
                </div>

                <!-- ç»“æœå†…å®¹ -->
                <div id="resultCard" class="hidden">
                    <div class="result-header">
                        <h2 style="color: var(--accent);">ğŸ’ é¦¨å©·çš„å»ºè®®</h2>
                        <p id="resultFor" style="color: var(--text-sub);">ç»™çˆ·çˆ·çš„å¥åº·è´´å£«</p>
                    </div>

                    <div class="suggest-content" id="resultContent" style="font-size: 18px; line-height: 1.8;">
                        <!-- AI å†…å®¹ -->
                    </div>

                    <div class="disclaimer">
                        âš ï¸ å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå¦‚æœä¸èˆ’æœå¾—å‰å®³ï¼Œä¸€å®šè¦å»åŒ»é™¢å“¦ï¼
                    </div>

                    <div style="margin-top: 30px;">
                        <button class="btn btn-success" onclick="speakResult()">ğŸ”Š æœ—è¯»å»ºè®®</button>
                        <button class="btn" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const symptomsData = {
            head: {
                name: "å¤´éƒ¨",
                icon: "ğŸ§ ",
                symptoms: ["å¤´æ™•", "å¤´ç–¼", "ç«™èµ·æ—¶å¤´æ™•", "è®°æ€§å·®", "ç‰™ç–¼"]
            },
            eyes: {
                name: "çœ¼ç›",
                icon: "ğŸ‘ï¸",
                symptoms: ["çœ¼ç›èŠ±", "çœ¼ç›å¹²æ¶©", "çœ¼ç›å‘çº¢", "çœ¼ç›æµæ³ª", "é£èšŠç—‡"]
            },
            nose: {
                name: "é¼»å­",
                icon: "ğŸ‘ƒ",
                symptoms: ["æ‰“å‘¼å™œ", "æµé¼»æ¶•", "é—»ä¸åˆ°å‘³é“"]
            },
            ears: {
                name: "è€³æœµ",
                icon: "ğŸ‘‚",
                symptoms: ["è€³é¸£", "è€³ç—›", "è€³æœµæµæ¶²ä½“"]
            },
            neck: {
                name: "é¢ˆæ¤/è‚©è†€",
                icon: "ğŸ§£",
                symptoms: ["è„–å­ç–¼", "è‚©è†€é…¸ç—›", "è„–å­åƒµç¡¬", "æ‰‹éº»", "å›å¤´å›°éš¾", "è‚©è†€æŠ¬ä¸èµ·æ¥", "èƒŒç—›", "è½æ•"]
            },
            chest: {
                name: "èƒ¸å£/å¿ƒè„",
                icon: "ğŸ’—",
                symptoms: ["èƒ¸é—·", "å¿ƒæ…Œ", "æ°”çŸ­", "å’³å—½", "å‘¼å¸å›°éš¾", "å¿ƒè·³å¿«", "å¿ƒå£ç–¼", "ç—°å¤š", "è¡€å‹é«˜"]
            },
            stomach: {
                name: "è‚šå­/è‚ èƒƒ",
                icon: "ğŸ«ƒ",
                symptoms: ["èƒƒç—›", "èƒƒèƒ€", "åé…¸", "æ¶å¿ƒ", "é£Ÿæ¬²å·®", "è‚šå­ç–¼", "ä¾¿ç§˜", "æ‹‰è‚šå­", "æ¶ˆåŒ–ä¸è‰¯"]
            },
            limbs: {
                name: "èƒ³è†Š/è…¿è„š",
                icon: "ğŸ¦µ",
                symptoms: ["è†ç›–ç–¼", "è…¿æŠ½ç­‹", "è„šè‚¿", "æ‰‹è„šéº»æœ¨", "å…³èŠ‚è‚¿ç—›", "èƒ³è†ŠæŠ¬ä¸èµ·", "èµ°è·¯ç´¯", "è„šåº•ç–¼", "æ‰‹æŠ–"]
            },
            whole: {
                name: "å…¨èº«",
                icon: "ğŸ§˜",
                symptoms: ["å¤±çœ ", "æ²¡åŠ›æ°”", "å‘çƒ§", "æ€•å†·", "ç¡ä¸å¥½", "å®¹æ˜“ç´¯", "æµ‘èº«é…¸ç—›", "å‡ºè™šæ±—", "çš®è‚¤ç—’", "æ°´è‚¿"]
            }
        };

        let state = { person: "", bodyPart: "", symptoms: [], voiceEnabled: false, resultText: "" };
        const synth = window.speechSynthesis;

        function speak(text) {
            if (!state.voiceEnabled || !synth) return;
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; utterance.rate = 0.85; utterance.pitch = 1; utterance.volume = 1;
            synth.speak(utterance);
        }

        // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isDark = body.classList.toggle('dark-mode');
            body.classList.remove('light-mode');
            if (isDark) {
                body.classList.add('dark-mode');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                themeIcon.textContent = 'ğŸŒ™';
                localStorage.setItem('theme', 'light');
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.textContent = 'â˜€ï¸';
            } else if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.textContent = 'ğŸŒ™';
            } else {
                // è·Ÿéšç³»ç»Ÿ
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    themeIcon.textContent = 'â˜€ï¸';
                }
            }
        }

        // çƒŸèŠ±åŠ¨æ•ˆå‡½æ•°
        function createFirework(x, y) {
            const colors = ['#6b9d7a', '#89a492', '#66D98F', '#52C77D', '#3FB56B'];
            const particleCount = 12;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'fixed';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.width = '6px';
                particle.style.height = '6px';
                particle.style.borderRadius = '50%';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '9999';

                document.body.appendChild(particle);

                const angle = (Math.PI * 2 * i) / particleCount;
                const velocity = 50 + Math.random() * 50;
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;

                particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
                ], {
                    duration: 600,
                    easing: 'cubic-bezier(0, .9, .57, 1)'
                }).onfinish = () => particle.remove();
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ä¸»é¢˜
        initTheme();

        function toggleVoice() {
            state.voiceEnabled = !state.voiceEnabled;
            const toggle = document.getElementById('voiceToggle');
            const icon = document.getElementById('voiceIcon');
            const text = document.getElementById('voiceText');
            if (state.voiceEnabled) {
                toggle.classList.add('active'); icon.textContent = 'ğŸ”Š'; text.textContent = 'è¯­éŸ³å¼€';
                speak('è¯­éŸ³å·²å¼€å¯');
            } else {
                toggle.classList.remove('active'); icon.textContent = 'ğŸ”‡'; text.textContent = 'è¯­éŸ³å…³';
                synth.cancel();
            }
        }

        function goToPage(pageNum) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page${pageNum}`).classList.add('active');
            const stepText = document.getElementById('stepText');
            if (pageNum < 4) {
                stepText.style.display = 'block'; stepText.textContent = `ç¬¬ ${pageNum} æ­¥ / å…± 3 æ­¥`;
            } else { stepText.style.display = 'none'; }
        }

        function goBack() {
            const activePage = document.querySelector('.page.active');
            const pageNum = parseInt(activePage.id.replace('page', ''));
            if (pageNum > 1) { goToPage(pageNum - 1); } else { goHome(); }
        }

        function goHome() { window.location.href = 'index.html'; }

        function selectPerson(person) {
            // è§¦å‘çƒŸèŠ±æ•ˆæœ
            const clickedBtn = event.target.closest('button');
            if (clickedBtn) {
                const rect = clickedBtn.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                createFirework(x, y);
            }

            setTimeout(() => {
                state.person = person;
                speak(`å¥½çš„ï¼Œ${person}å“ªé‡Œä¸èˆ’æœå‘¢ï¼Ÿ`);
                goToPage(2);
            }, 100);
        }

        function selectBodyPart(part) {
            // è§¦å‘çƒŸèŠ±æ•ˆæœ
            const clickedCard = event.target.closest('.body-card');
            if (clickedCard) {
                const rect = clickedCard.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                createFirework(x, y);
            }

            setTimeout(() => {
                state.bodyPart = part;
                const partData = symptomsData[part];
                document.getElementById('symptomIcon').textContent = partData.icon;
                document.getElementById('symptomPageTitle').textContent = `${partData.name}æœ‰ä»€ä¹ˆç—‡çŠ¶ï¼Ÿ`;
                const grid = document.getElementById('symptomsGrid');
                grid.innerHTML = partData.symptoms.map(s => `<div class="symptom-tag" onclick="toggleSymptom('${s}', this)">${s}</div>`).join('');
                state.symptoms = []; updateSelectedTags();
                speak(`${partData.name}ï¼Œè¯·é€‰æ‹©å…·ä½“ç—‡çŠ¶`);
                goToPage(3);
            }, 100);
        }

        function toggleSymptom(symptom, el) {
            const index = state.symptoms.indexOf(symptom);
            if (index > -1) { state.symptoms.splice(index, 1); el.classList.remove('active'); }
            else { state.symptoms.push(symptom); el.classList.add('active'); }
            updateSelectedTags();
        }

        function updateSelectedTags() {
            const container = document.getElementById('selectedTags');
            const btn = document.getElementById('submitBtn');
            if (state.symptoms.length === 0) {
                container.innerHTML = '<span style="color:#a0aec0;">ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©ç—‡çŠ¶</span>';
                btn.disabled = true;
            } else {
                container.innerHTML = state.symptoms.map(s => `<span class="symptom-tag active" style="margin:2px; font-size:14px; padding:6px 12px; cursor:default;">${s}</span>`).join('');
                btn.disabled = false;
            }
        }

        async function submitSymptoms() {
            goToPage(4);
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            speak('é¦¨å©·æ­£åœ¨ä¸ºæ‚¨åˆ†æï¼Œè¯·ç¨ç­‰');

            try {
                // ä½¿ç”¨åç«¯ API
                const response = await fetch('/api/health', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        person: state.person,
                        bodyPart: symptomsData[state.bodyPart].name,
                        symptoms: state.symptoms
                    })
                });

                if (!response.ok) throw new Error('è¯·æ±‚å¤±è´¥');
                const data = await response.json();
                showResult(data.advice);
            } catch (error) {
                console.error(error);
                showResult('æŠ±æ­‰ï¼Œé¦¨å©·æš‚æ—¶æ— æ³•åˆ†æã€‚\n\nè¯·ç›´æ¥å‘Šè¯‰å®¶äººæ‚¨çš„ç—‡çŠ¶ã€‚\n\nå¦‚æœå¾ˆä¸èˆ’æœï¼Œä¸€å®šè¦å°½å¿«å»çœ‹åŒ»ç”Ÿå“¦ï¼');
            }
        }

        function showResult(advice) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('resultFor').textContent = `ç»™${state.person}çš„å»ºè®®`;
            const formattedAdvice = advice.replace(/### (.*)/g, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/- (.*)/g, '<li>$1</li>');
            document.getElementById('resultContent').innerHTML = formattedAdvice;
            state.resultText = advice.replace(/[#*\-]/g, '').replace(/\n+/g, 'ã€‚');
            speakResult();
        }

        function speakResult() {
            if (state.resultText) speak(`${state.person}ï¼Œé¦¨å©·ç»™æ‚¨çš„å»ºè®®æ˜¯ï¼š${state.resultText}`);
        }
    </script>
</body>

</html>